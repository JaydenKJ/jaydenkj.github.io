<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="navbar">

    </div>
    <form class="form" id="form">
        <div class="form-element">
            <label for="name">Your name</label>
            <input type="text" name="name">
        </div>
        <div class="form-element">  
            <label for="date">Date you want to visit</label>
            <input type="date" name="date" required>
        </div>
        <div class="form-element"> 
            <label for="people">How many people?</label>
            <input type="number" name="people" required>
        </div>
        <div class="form-element">
            <label for="phone-number">Phone number</label>
            <input type="tel" name="phone_number" required>
        </div>
        <div class="form-element">
            <label for="email">Email</label>
            <input type="email" name="email" required>
        </div>
        <div class="form-element">
            <input type="submit" value="submit">
        </div>
    </form>
    <div class="submitted" id="submitted" style="display: none;">
        <div class="top">
            <p class="success">Your reservation has been successfully completed. Please copy the reservation code by tapping it or screenshot or save the qr code as you will need it to check in on the date you selected.</p>
            <div class="reservation-code">
                <p id="reservation_code" onclick="copyToClipboard()">PLACEHOLDER_TEXT</p>
                <div class="svg-wrapper" onclick="copyToClipboard()">
                    <img src="copy-svgrepo-com.svg" alt="">
                </div>
            </div>
            <p class="copied" id="copied" style="display: none;">copied to clipboard</p>
            <div class="qrcode-wrapper">
                <div class="qrcode" id="qr_code">QR code generating...</div>
            </div>    
        </div>
        <div class="bottom">
            <div class="download" onclick="download()">Save QR code</div>
            <div class="done" onclick="done()">done</div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
document.getElementById('form').addEventListener('submit', async function (e) {
    e.preventDefault(); // Prevent default form submission

    // Generate a unique ID
    var uniqueId = Date.now().toString(36) + Math.random().toString(36).substring(2);

    // Collect form data
    var formData = new FormData(e.target);
    var data = { id: uniqueId }; // Start with the generated ID
    formData.forEach((value, key) => data[key] = value);

    try {
        // Send data to Google Apps Script
        await fetch('https://script.google.com/macros/s/AKfycbwVDsqh3rEamzXMhF22hA8w4jcR7Q0wqCQjHHX9Q_yiaPf95sM56ZoXYS6ICZrKSeY5/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
            mode: 'no-cors'
        });

        // Notify the user of the ID and display it
        document.getElementById('form').reset(); // Clear the form

        // Update the reservation_code element and show the container
        var reservationElement = document.getElementById('reservation_code');
        reservationElement.textContent = uniqueId; // Set the unique ID

        var submittedElement = document.getElementById('submitted');
        submittedElement.style.display = 'block'; // Show the submitted message

        // Generate QR code
        var qrCodeContainer = document.getElementById('qr_code');
        qrCodeContainer.innerHTML = ''; // Clear any existing QR code
        new QRCode(qrCodeContainer, uniqueId); // Generate a new QR code
    } catch (error) {
        console.error('Error:', error);
        alert('Error submitting form');
    }
});

function copyToClipboard() {
    var reservationCode = document.getElementById('reservation_code').textContent; // Get the text to copy
    navigator.clipboard.writeText(reservationCode).then(() => {
        
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy the reservation code.');
    });
    document.getElementById('copied').style.display = 'block';
}

function done() {

    document.getElementById('submitted').style.display = 'none';

}

function download() {
        const qrDiv = document.getElementById("qr_code");
        const qrImage = qrDiv.querySelector("img"); // Check for generated image
        const qrCanvas = qrDiv.querySelector("canvas"); // Check for generated canvas

        if (qrImage && qrImage.src) {
            // If an <img> is present, download it
            const link = document.createElement("a");
            link.href = qrImage.src;
            link.download = "qr-code.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else if (qrCanvas) {
            // If a <canvas> is present, convert to image and download
            const link = document.createElement("a");
            link.href = qrCanvas.toDataURL("image/png");
            link.download = "qr-code.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("QR Code not generated yet!");
        }
    }



    </script>
</body>
</html>