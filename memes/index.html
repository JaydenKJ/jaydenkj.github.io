<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
     <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        img-src 'self' https://bold-filly-noble.ngrok-free.app data:;
        connect-src 'self' https://bold-filly-noble.ngrok-free.app;
        script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; ">
    <title>Memes :/</title>
    <style>
    
        /* montserrat-600 - latin */
        @font-face {
          font-display: swap; /* Check https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display for other options. */
          font-family: 'Montserrat';
          font-style: normal;
          font-weight: 600;
          src: url('fonts/montserrat-v30-latin-600.woff2') format('woff2'); /* Chrome 36+, Opera 23+, Firefox 39+, Safari 12+, iOS 10+ */
        }
        
        /* montserrat-700 - latin */
        @font-face {
          font-display: swap; /* Check https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display for other options. */
          font-family: 'Montserrat';
          font-style: normal;
          font-weight: 700;
          src: url('fonts/montserrat-v30-latin-700.woff2') format('woff2'); /* Chrome 36+, Opera 23+, Firefox 39+, Safari 12+, iOS 10+ */
        }
        
        /* open-sans-regular - latin */
        @font-face {
          font-display: swap; /* Check https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display for other options. */
          font-family: 'Open Sans';
          font-style: normal;
          font-weight: 400;
          src: url('fonts/open-sans-v43-latin-regular.woff2') format('woff2'); /* Chrome 36+, Opera 23+, Firefox 39+, Safari 12+, iOS 10+ */
        }
        
        /* open-sans-600 - latin */
        @font-face {
          font-display: swap; /* Check https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display for other options. */
          font-family: 'Open Sans';
          font-style: normal;
          font-weight: 600;
          src: url('fonts/open-sans-v43-latin-600.woff2') format('woff2'); /* Chrome 36+, Opera 23+, Firefox 39+, Safari 12+, iOS 10+ */
        }



        
        :root {
            --primary-color: #6a0dad; /* Deep Purple */
            --secondary-color: #8338ec; /* Slightly Lighter Purple */
            --accent-color: #ffbe0b; /* Vibrant Yellow/Orange */
            --background-light: #f7f9fc;
            --background-dark: #2c3e50; /* Dark Blue-Gray for header */
            --card-background: #ffffff;
            --text-dark: #333;
            --text-light: #fefefe;
            --border-color: #e0e0e0;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.2);
            --border-radius: 10px;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        header {
            background: var(--background-dark);
            color: var(--text-light);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 1.5px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Forms Styling */
        form {
            background: var(--card-background);
            padding: 1.5rem;
            margin: 1rem auto 2rem auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            max-width: 600px; /* Limit form width */
            border: 1px solid var(--border-color);
        }

        form h2 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        input[type="text"],
        input[type="file"],
        textarea,
        button {
            width: calc(100% - 1rem); /* Account for padding */
            padding: 0.8rem;
            margin: 0.7rem 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
        }

        input[type="file"] {
            border: none; /* File input often styled differently */
            padding-left: 0;
        }

        input[type="text"]:focus,
        textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(131, 56, 236, 0.2);
        }

        textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 80px;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Preview Image */
        #previewImg {
            max-width: 100%;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: block; /* Ensure it takes full width when visible */
            height: auto; /* Maintain aspect ratio */
        }

        /* Gallery Grid */
        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Slightly larger cards */
            gap: 1.5rem; /* Increased gap */
            padding: 1.5rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .meme-card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            cursor: pointer; /* Indicate it's clickable */
        }

        .meme-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .meme-card img {
            width: 100%;
            height: 300px; /* Fixed height for images */
            object-fit: contain; /* Cover the area, crop if necessary */
            display: block;
            border-bottom: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .meme-card:hover img {
            transform: scale(1.03); /* Slight zoom on hover */
        }

        .meme-card-content {
            padding: 1rem;
            flex-grow: 1; /* Allows content to take available space */
            display: flex;
            flex-direction: column;
        }

        .meme-card h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
            font-size: 1.2rem;
            word-break: break-word; /* Prevent long words from overflowing */
        }

        .meme-card p {
            margin: 0;
            font-size: 0.9rem;
            color: #555;
            flex-grow: 1; /* Pushes description to fill space */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit description to 3 lines */
            -webkit-box-orient: vertical;
        }

        /* Load More Button */
        #loadMore {
            background: var(--accent-color);
            color: var(--text-dark);
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }

        #loadMore:hover {
            background: #e6a700; /* Simple darken effect for accent */
            transform: translateY(-2px);
        }

        /* Search Form Specifics */
        #searchForm {
            margin-bottom: 2rem;
        }

        #searchInput {
            border-radius: 50px; /* Pill shape */
            padding: 0.8rem 1.5rem;
            margin-bottom: 0; /* Remove bottom margin if it's the only input */
            text-align: center;
        }

        /* Full Meme Overlay */
        #fullMemeOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Dark transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* On top of everything */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #fullMemeOverlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .full-meme-content {
            background: var(--card-background);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            max-width: 90%; /* Adjust max width for larger screens */
            max-height: 90%; /* Adjust max height */
            overflow-y: auto; /* Enable scrolling if content overflows */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            text-align: center;
            box-sizing: border-box;
        }

        .full-meme-content img {
            max-width: 100%;
            max-height: 70vh; /* Limit image height to screen height */
            height: auto;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            object-fit: contain; /* Ensure entire image is visible, no cropping */
        }

        .full-meme-content h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .full-meme-content p {
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .full-meme-content .meme-number {
            font-size: 0.9rem;
            color: #777;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #bbb;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover {
            color: #fefefe;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            form {
                margin: 1rem;
            }
            #gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Smaller cards on mobile */
                gap: 1rem;
                padding: 1rem;
            }
            .meme-card img {
                height: 200px;
            }
            .full-meme-content {
                padding: 1.5rem;
            }
            .full-meme-content h3 {
                font-size: 1.5rem;
            }
            .full-meme-content p {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            form {
                padding: 1rem;
            }
            input, textarea, button {
                padding: 0.7rem;
            }
            .meme-card h3 {
                font-size: 1.1rem;
            }
            .meme-card p {
                font-size: 0.85rem;
            }
            .close-button {
                top: 10px;
                right: 10px;
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Meme Gallery</h1>
        </div>
    </header>

    <div class="container">

        <h4 style="align-text: center;">If you are having issues with memes loading, please try going <a href="https://bold-filly-noble.ngrok-free.app">here</a> and hitting "Visit site".</h4>
        

         <form id="searchForm">
            <input type="text" id="searchInput" placeholder="Search memes by title or description..." />
        </form>

        

        <div id="gallery"></div>
        <button id="loadMore">Load More Memes</button>


        <form id="uploadForm">
            <h2>Upload a New Meme</h2>
            <input type="file" name="meme" accept="image/*" required />
            <img id="previewImg" src="" alt="Image Preview" style="display:none;" />
            <input type="text" name="title" placeholder="Catchy Meme Title" required />
            <textarea name="description" placeholder="A brief description or relatable text..." required></textarea>
            <button type="submit">Upload Meme</button>
        </form>
       
    </div>

    <div id="fullMemeOverlay">
        <div class="full-meme-content">
            <span class="close-button">&times;</span>
            <img id="fullMemeImg" src="" alt="Full Meme" />
            <h3 id="fullMemeTitle"></h3>
            <p id="fullMemeDescription"></p>
            <p class="meme-number">Meme #<span id="fullMemeNumber"></span></p>
        </div>
    </div>

    <script>
    const BASE_URL = 'https://bold-filly-noble.ngrok-free.app'; // IMPORTANT: Keep this updated with your actual Tailscale URL!
    const NGROK_HEADERS = { 'ngrok-skip-browser-warning': 'true' };

    const gallery = document.getElementById('gallery');
    const uploadForm = document.getElementById('uploadForm');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const loadMore = document.getElementById('loadMore');
    const previewImg = document.getElementById('previewImg');

    // Full Meme Overlay elements
    const fullMemeOverlay = document.getElementById('fullMemeOverlay');
    const fullMemeImg = document.getElementById('fullMemeImg');
    const fullMemeTitle = document.getElementById('fullMemeTitle');
    const fullMemeDescription = document.getElementById('fullMemeDescription');
    const fullMemeNumber = document.getElementById('fullMemeNumber');
    const closeButton = document.querySelector('.close-button');

    let offset = 0;
    const limit = 10;
    let searching = false;

    function createMemeCard(meme) {
        const card = document.createElement('div');
        card.className = 'meme-card';
        // Add data attributes to store full information for click event
        card.dataset.title = meme.title;
        card.dataset.description = meme.description;
        card.dataset.filepath = BASE_URL + meme.filepath; // Store full path for convenience
        card.dataset.number = meme.number; // Store the meme number

        card.innerHTML = `
            <img src="${BASE_URL + meme.filepath}" alt="${meme.title}" loading="lazy" />
            <div class="meme-card-content">
                <h3>${meme.title}</h3>
                <p>${meme.description}</p>
            </div>
        `;

        // Add click event listener to the card
        card.addEventListener('click', () => {
            showFullMeme(meme); // Pass the entire meme object
        });

        return card;
    }

    // Function to display the full meme
    function showFullMeme(meme) {
        fullMemeImg.src = BASE_URL + meme.filepath;
        fullMemeImg.alt = meme.title;
        fullMemeTitle.textContent = meme.title;
        fullMemeDescription.textContent = meme.description;
        fullMemeNumber.textContent = meme.number;
        fullMemeOverlay.classList.add('visible');
        document.body.style.overflow = 'hidden'; // Prevent scrolling body when overlay is active
    }

    // Function to hide the full meme overlay
    function hideFullMeme() {
        fullMemeOverlay.classList.remove('visible');
        document.body.style.overflow = ''; // Restore body scrolling
    }

    // Event listener for the close button
    closeButton.addEventListener('click', hideFullMeme);

    // Event listener to close overlay when clicking outside the content
    fullMemeOverlay.addEventListener('click', (e) => {
        if (e.target === fullMemeOverlay) { // Only close if clicking the overlay background itself
            hideFullMeme();
        }
    });

    // Event listener for ESC key to close overlay
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && fullMemeOverlay.classList.contains('visible')) {
            hideFullMeme();
        }
    });

    async function loadMemes(reset = false) {
        const url = searching
            ? `${BASE_URL}/search?q=${encodeURIComponent(searchInput.value)}`
            : `${BASE_URL}/memes?offset=${offset}&limit=${limit}`;

        try {
            const res = await fetch(url, { headers: NGROK_HEADERS });
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const memes = await res.json();

            if (reset) {
                gallery.innerHTML = '';
                offset = 0;
            }
            memes.forEach(meme => gallery.appendChild(createMemeCard(meme)));
            if (!searching) offset += limit;

            if (memes.length < limit && !searching) { // Only hide if not searching and less than limit
                loadMore.style.display = 'none';
            } else if (!searching) { // Show if not searching and might have more
                loadMore.style.display = 'block';
            } else if (searching && memes.length === 0) { // If searching and no results
                gallery.innerHTML = '<p style="text-align: center; color: #555;">No memes found matching your search.</p>';
                loadMore.style.display = 'none';
            } else if (searching && memes.length > 0) { // If searching and found results, hide load more
                loadMore.style.display = 'none'; // Search results typically aren't paginated with load more
            }

        } catch (error) {
            console.error("Failed to load memes:", error);
            if (reset) gallery.innerHTML = '<p style="text-align: center; color: red;">Failed to load memes. Please try again later.</p>';
        }
    }

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);

        try {
            const response = await fetch(`${BASE_URL}/upload`, {
                method: 'POST',
                body: formData,
                headers: NGROK_HEADERS
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Upload failed! Status: ${response.status}, Message: ${errorText}`);
            }

            alert('Meme uploaded successfully!');
            uploadForm.reset();
            previewImg.style.display = 'none';
            offset = 0;
            loadMemes(true);

        } catch (error) {
            console.error("Error uploading meme:", error);
            alert(`Error uploading meme: ${error.message}`);
        }
    });

    uploadForm.elements.meme.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                previewImg.src = event.target.result;
                previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewImg.src = '';
            previewImg.style.display = 'none';
        }
    });

    searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        searching = true;
        offset = 0;
        loadMemes(true);
    });

    searchInput.addEventListener('input', () => {
        if (searchInput.value.trim() === '') {
            searching = false;
            offset = 0;
            loadMemes(true);
        } else if (!searching) {
            searching = true;
            offset = 0;
            loadMemes(true);
        }
    });

    loadMore.addEventListener('click', () => {
        if (!searching) {
            loadMemes();
        }
    });

    loadMemes();
</script>

</body>
</html>
